---
title: 性能优化之资源缓存与更新
date: 2017-05-22 17:48:41
categories: coding
tags:
  - 缓存
---

在上一节性能优化之静态资源优化中，我们对博客中使用到的 CSS、JavaScript、图片等做了比如大小、合并、懒加载等优化，在这一节中，我们将使用浏览器的缓存能力，对这些资源进行进一步的优化，来提升首屏加载速度等，并且我们还将讨论，针对缓存在浏览器中的数据，如何进行缓存的更新。

<!--more-->

## 使用 LocalStorage 进行本地存储

关于 LocalStorage 的介绍可以查看 [Window.localStorage | MDN](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/localStorage) 和 [使用 Web Storage API](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Storage_API/Using_the_Web_Storage_API)，我这里就不再赘述了。

首先，我们需要进行本地存储的项目有，CSS 文件和 JS 文件，特别是 CSS 文件中添加了 Data URI 以后，文件的大小会增加很多，这种文件可以考虑使用 LocalStorage 进行缓存，也有一些全局的样式，全局的 JS 文件，或者一些不经常改变的文件或样式都可以考虑使用 LocalStorage 进行缓存，下面，我们将展示的是对 CSS 文件的缓存。

### 函数的定义

首先定义 LocalStorage Save(`ls`) 函数和 LocalStorage Load(`ll`) 函数，用来保存文件内容到 LocalStorage 里面和从 LocalStorage 读取内容，添加到 `<head>` 中。


```
function ls(name) {
  let target = document.getElementById(name);
  if (!target) {
    throw new Error('ls save fn not find ' + name);
  } else {
    window.localStorage.setItem(name, target.innerHTML);
  }
}
function ll(name, tag) {
  let storage = window.localStorage.getItem(name);
  if (!storage) {
    throw new Error('ls load fn not find ' + name);
  } else {
    let type = tag ? 'script' : 'style';  // 设置 0 来添加 style，设置 1 来添加 script
    let elem = document.createElement(type);
    elem.innerHTML = storage;
    document.head.appendChild(elem);
  }
}
```

除了实现添加功能以外，还需要使用 `cookie` 来标记用户。如果用户已经下载 `common_css`，则下次就不用在 HTML 页面中添加 `common_css` 的部分，而是转为调用 `ll('common_css', 0);`。这一部分的内容通过 Express 中间件来实现：

```
exports.checkll = function(req, res, next) {
  if (req.cookies.v) {
    req.visited = true;
  } else {
    req.visited = false;
    res.cookie('v', 0, {});
  }
  next();
}
```

将 `visited` 获取后传给 Pug 来设置是使用 `ls('common_css')` 函数还是使用 `ll('common_css', 0);`。

```
block commonStyle
  - if (!visited)
    style#common_css
    include ../../www/static/css/common-combo.css
    script ls('common_css', 0);
  - else
    script ll('common_css', 0);
```

修改 `Pug` 模板中的内容，将需要缓存的公用的内容再重新分离出来，比如 `header`，`page-nav` 等内容。然后把不同页面转换的时候要切换的文件写在一个新的 `<style>` 标签中。

```
block commonStyle
block uniqueStyle

// common-combo.css 中的样式
@import '../../layout/layout.css';
@import '../../header/header.css';
@import '../../page-nav/page-nav.css';
@import '../../footer/footer.css';
```

最后，我们可以比较一下使用 LocalStorage 前后传输的文件的大小差距：

