---
title: 前端的那些（比较）新协议
date: 2017-10-18 21:20:16
catebories: coding
tags:
  - 协议
---

由于现在前端业务的飞速发展，与之相关的前端协议也在不断出现，为前端的进步提供更多的可能性。在本文中，总结了一下常用的比较新的前端协议，其实有的协议其实也有些年头了，但是大家可能接触的也不是很多，通过本文，希望给大家带来一些大体上的认知。

<!--more-->

## WebSocket

 HTTP 协议有一个缺陷：通信只能由客户端发起。
 
 对于那些实时要求比较高的应用来说，比如说在线游戏、在线证券、设备监控、新闻在线播报、RSS 订阅推送等等，当客户端浏览器准备呈现这些信息的时候，这些信息在服务器端可能已经过时了。所以保持客户端和服务器端的信息同步是实时 Web 应用的关键要素，对 Web 开发人员来说也是一个难题。在 WebSocket 规范出来之前，开发人员想实现这些实时的 Web 应用，不得不采用一些折衷的方案，其中最常用的就是轮询 (Polling) 和 Comet 技术，而 Comet 技术实际上是轮询技术的改进，又可细分为两种实现方式，一种是长轮询机制，一种称为流技术。下面我们简单介绍一下这几种技术：
 
### 轮询

这是最早的一种实现实时 Web 应用的方案。客户端以一定的时间间隔向服务端发出请求，以频繁请求的方式来保持客户端和服务器端的同步。

### Comet

而 Comet 技术实际上是轮询技术的改进，又可细分为两种实现方式，一种是长轮询机制，一种称为流技术。

#### 长轮询

长轮询把短轮询颠倒了一下，页面发起一个到服务器的请求，然后服务器一致保持连接打开，直到有数据可以发送。发送完数据后，浏览器关闭连接，随即又发起一个到服务器的新请求，这一过程呢在页面打开期间一直持续不断。当然，如果服务端的数据变更非常频繁的话，这种机制和定时轮询比较起来没有本质上的性能的提高。

#### HTTP 流

流技术方案通常就是在客户端的页面使用一个隐藏的窗口向服务端发出一个长连接的请求。服务器端接到这个请求后作出回应并不断更新连接状态以保证客户端和服务器端的连接不过期。

HTTP 流在整个生命周期内只使用一个 HTTP 连接，就是浏览器向服务器发送一个请求，而服务器保持连接打开，然后周期性地向浏览器发送数据。

但是管理 Comet 是很容易出错的，所以为了简化这一技术，又为 Comet 创建了两个新的接口。

#### Server-Sent Events (SSE)

服务器发送事件，是围绕只读 Comet 交互推出的 API 或者模式。SSE API 用于创建到服务器的单向连接，服务器通过这个连接可以发送任意数量的数据。服务器响应的 MIME 类型必须是 text/event-stream。

使用方法是创建一个 `EventSource` 对象，然后主要配置 `open、message、error` 这三个事件的处理程序。

```
let source = new EventSource("myevents.php");
source.onmessage = function(event) {
    let data = event.data;
    // 处理数据
}
```

默认情况下，EventSource 对象会保持与服务器的活动连接，如果连接断开，还会重新连接。这意味着 SSE 适合长轮询和 HTTP 流。如果想强制立即断开连接并且不再重新连接，可以调用 `source.close()`

除此以外，还可以给特定事件添加一个 `id`，如果连接断开，`EventSource` 对象会跟踪上一次触发的事件，从而向服务器发送该 `id`，让服务器知道下一次该触发哪个事件。

### WebSocket








## 参考

* [WebSocket 教程](http://www.ruanyifeng.com/blog/2017/05/websocket.html)
* [使用 HTML5 WebSocket 构建实时 Web 应用 | 比较老，可以参考](https://www.ibm.com/developerworks/cn/web/1112_huangxa_websocket/)
