---
title: 性能优化之 静态资源优化
date: 2017-05-16 15:52:35
tags:
  - JavaScript
  - CSS
---

在本博客中，对 JavaScript 代码和 CSS 代码进行了压缩，并且将压缩后的代码通过内联的信息放在了 HTML 中，用来节省多次 TCP 请求的时间。客户端在接收了 CSS 文件和 JS 文件以后，会存在本地的 LocalStorage 缓存里，在下一次使用的时候就不需要再次请求了。

## CSS 静态资源优化

### 集成并压缩 CSS 文件

针对前一篇博客中提到的过多的 CSS 请求，会导致多次简历 TCP 连接，所以对网页的首屏渲染造成延迟的影响，所以我们要做的是，将不同的 CSS 文件合并成一个 CSS 文件，并且以内联的形式添加到 HTML 页面中。

我的博客自动化框架使用的是 Gulp，所以针对 Gulp，使用 PostCSS 框架，来进行 CSS 的自动添加前缀，CSS 文件的合并，CSS 文件的压缩和导出。

首先安装需要的插件：

```
npm install --save-deve gulp-postcss
npm install --save-deve autoprefixer
npm install --save-deve postcss-import
npm install --save-deve css-mqpacker
npm install --save-deve cssnano
```

并且在 `gulpfile.js` 中导入模块，创建 `css` 任务：

```
let postcss = require('gulp-postcss');
let autoprefixer = require('autoprefixer');
let atImport = require('postcss-import');
let mqpacker = require('css-mqpacker'); 
let cssnano = require('cssnano');

gulp.task('css', function () { 
  var processors = [autoprefixer, atImport, mqpacker, cssnano]; 
  return gulp.src('./view/output/*-combo.css')
    .pipe(postcss(processors))
    .pipe(gulp.dest('./www/static/css')); 
});
```

根据我们的 `css` 任务的定义，我们要在 `/view/output/` 中创建结尾为 `-combo.css` 的 CSS 文件，用来表示合成的 CSS 文件，我们以 `article-combo.css` 文件为例，其中的内容为：

```
@import '../layout/layout.css';
@import '../header/header.css';
@import '../page-nav/page-nav.css';
@import '../footer/footer.css';
@import '../article/article.css';
```

里面的内容很简单，就是使用 `@import` 将相关的 CSS 文件引入，然后 `postcss-import` 就可以根据 `@import` 进来的 CSS 文件路径来合成多个 `CSS` 文件。

除此以外，还需要创建的 CSS 文件有：

```
admin-login-combo.css
archives-combo.css
article-combo.css
home-combo.css
list-combo.css
series-combo.css
upload-combo.css
```

此时，可以删除 Pug 文件中原来的 CSS 文件，然后使用 `include` 来引入集成好的 CSS 文件。

最后删除原来 Pug 模板中的 CSS 文件，引入新的集成好的 CSS 文件。

我们可以对比一下 CSS 文件集成前后的区别：

**首页**：

因为首页传输的图片数量比较小，所以可以在 Chrome Network 里面设置网络的情况为：Regular 2G (250kb/s)，并且关闭所有的缓存。当 CSS 文件没有被集成之前：

![](http://ojt6zsxg2.bkt.clouddn.com/224b214c920050009c1d0ecb7eb392e1.png)

在 `Load` 事件被触发的时候，差不多用了 1s 的时间。

当我们设置使用集成的 CSS 文件以后，首页加载的情况如下：

![](http://ojt6zsxg2.bkt.clouddn.com/46adb266719dad63b145aa77ee728e0f.png)

从上图中，我们可以看到，网页中已经没有多余的 CSS 文件来影响首屏渲染速度，当 HTML 加载完成后，也就代表着 CSS 文件加载完成，此时的速度差不多为 `650ms`，几乎是前面加载多个 CSS 文件的一半！

所以，由此我们可以看出，将多个 CSS 文件合并成一个 CSS 文件，并且通过内联模式引入到 HTML 页面中，可以节省很大一部分时间。









